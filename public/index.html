<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>ğŸš€ è¿œç¨‹è®¾å¤‡ç®¡ç† Â· Neon Control</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        :root {
            --neon-purple: #8e2de2;
            --neon-blue: #00dbde;
            --online: #00ff9d;
            --offline: #ff416c;
            --warning: #ffd200;
            --danger: #ff4b2b;
            --bg-card: rgba(25, 25, 45, 0.85);
            --bg-body: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            --text-primary: #f0f0f0;
            --text-secondary: #a0a0ff;
            --text-muted: #8888cc;
            --border-color: rgba(100, 100, 255, 0.2);
            --shadow-color: rgba(0, 0, 0, 0.4);
            --card-hover-glow: rgba(138, 43, 226, 0.3);
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--bg-body);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 50px;
            animation: fadeIn 1s ease-out;
            position: relative;
        }

        header::after {
            content: '';
            position: absolute;
            bottom: -15px;
            left: 50%;
            transform: translateX(-50%);
            width: 120px;
            height: 3px;
            background: linear-gradient(90deg, transparent, var(--neon-blue), transparent);
        }

        h1 {
            font-size: 3rem;
            font-weight: 800;
            background: linear-gradient(90deg, var(--neon-blue), var(--neon-purple));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-shadow: 0 0 15px rgba(255, 255, 255, 0.2);
            margin-bottom: 15px;
            letter-spacing: 1px;
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 1.2rem;
            letter-spacing: 1px;
            max-width: 600px;
            margin: 0 auto;
            font-weight: 300;
        }

        .card {
            background: var(--bg-card);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            border: 1px solid var(--border-color);
            padding: 30px;
            margin-bottom: 30px;
            transition: all 0.4s ease;
            box-shadow: 0 10px 30px var(--shadow-color);
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--neon-blue), var(--neon-purple));
            transform: scaleX(0);
            transition: transform 0.4s ease;
        }

        .card:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 40px var(--shadow-color), 0 0 20px var(--card-hover-glow);
            border-color: rgba(138, 43, 226, 0.4);
        }

        .card:hover::before {
            transform: scaleX(1);
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .card-header i {
            font-size: 1.4rem;
            background: linear-gradient(90deg, var(--neon-blue), var(--neon-purple));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .card-header h3 {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 18px;
            margin-bottom: 20px;
        }

        input, select, button {
            padding: 16px;
            font-size: 16px;
            border: none;
            border-radius: 12px;
            width: 100%;
            outline: none;
            background: rgba(10, 10, 25, 0.8);
            color: white;
            border: 1px solid var(--border-color);
            transition: all 0.3s;
        }

        input:focus, select:focus {
            border-color: var(--neon-blue);
            box-shadow: 0 0 0 2px rgba(0, 219, 222, 0.3);
            transform: translateY(-2px);
        }

        button {
            background: linear-gradient(90deg, var(--neon-purple), #4a00e0);
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        button:hover:not(:disabled):not(.processing)::before {
            left: 100%;
        }

        button:hover:not(:disabled):not(.processing) {
            background: linear-gradient(90deg, #4a00e0, var(--neon-purple));
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(138, 43, 226, 0.4);
        }

        button.danger {
            background: linear-gradient(90deg, var(--danger), #ff416c);
        }

        button.warning {
            background: linear-gradient(90deg, #f7971e, var(--warning));
            color: #000;
        }

        button.secondary {
            background: rgba(80, 80, 120, 0.5);
        }

        button.copy-token {
            background: linear-gradient(90deg, #00c9ff, #92fe9d);
            color: #000;
            font-weight: bold;
        }

        button:disabled,
        button.processing {
            opacity: 0.65;
            cursor: not-allowed;
            transform: none;
        }

        pre.token-output {
            background: rgba(0, 0, 0, 0.4);
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
            font-family: 'Fira Code', monospace;
            font-size: 14px;
            display: none;
            white-space: pre-wrap;
            border-left: 3px solid var(--neon-blue);
            color: #00ffcc;
            overflow-x: auto;
            position: relative;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5);
        }

        .copy-btn-container {
            position: absolute;
            top: 10px;
            right: 10px;
        }

        .device-list {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .device-item {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            padding: 28px;
            background: rgba(20, 20, 40, 0.6);
            border-radius: 18px;
            border-left: 4px solid var(--neon-purple);
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .device-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(142, 45, 226, 0.05), transparent);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .device-item:hover::before {
            opacity: 1;
        }

        .device-item.offline {
            opacity: 0.85;
            border-left-color: var(--offline);
        }

        @media (max-width: 900px) {
            .device-item {
                grid-template-columns: 1fr;
            }
        }

        .device-meta {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .device-name {
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .device-id-type {
            font-size: 0.95rem;
            color: var(--text-muted);
        }

        .last-seen {
            font-size: 0.92rem;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .schedule-section {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .schedule-header {
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-secondary);
            font-weight: 600;
        }

        .schedule-info {
            padding: 14px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            font-size: 0.95rem;
            display: flex;
            flex-direction: column;
            gap: 8px;
            min-height: 90px;
            justify-content: space-between;
            transition: all 0.3s;
        }

        .schedule-info:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .schedule-info.running {
            border-left: 3px solid var(--online);
        }

        .schedule-info.paused {
            border-left: 3px solid var(--warning);
        }

        .schedule-info.none {
            border-left: 3px solid #666;
            color: #aaa;
            justify-content: center;
            min-height: 60px;
        }

        .task-time {
            font-weight: bold;
            color: #e0e0ff;
            font-size: 1.1rem;
        }

        .device-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 16px;
        }

        .device-actions button {
            min-width: 110px;
            flex: 1 1 auto;
            text-align: center;
            padding: 12px;
            font-size: 0.9rem;
        }

        .empty, .loading {
            text-align: center;
            color: var(--text-muted);
            padding: 40px 20px;
            font-style: italic;
            font-size: 1.1rem;
        }

        .loading::after {
            content: "â—";
            animation: blink 1.4s infinite;
            color: var(--neon-blue);
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(0, 219, 222, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(0, 219, 222, 0); }
            100% { box-shadow: 0 0 0 0 rgba(0, 219, 222, 0); }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 6px;
        }

        .status-online {
            background-color: var(--online);
            box-shadow: 0 0 8px var(--online);
        }

        .status-offline {
            background-color: var(--offline);
            box-shadow: 0 0 8px var(--offline);
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 2.2rem;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .device-actions {
                justify-content: center;
            }

            .device-item {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <header>
        <h1><i class="fas fa-microchip"></i> è¿œç¨‹è®¾å¤‡ç®¡ç†</h1>
        <div class="subtitle">âš¡ å®æ—¶æ§åˆ¶ Â· å…³æœº/å¼€æœºå®šæ—¶ Â· è®¾å¤‡åˆ†ç±»</div>
    </header>

    <div class="card">
        <div class="card-header">
            <i class="fas fa-plus-circle"></i>
            <h3>æ·»åŠ æ–°è®¾å¤‡</h3>
        </div>
        <div class="form-grid">
            <input type="text" id="deviceId" placeholder="è®¾å¤‡IDï¼ˆå”¯ä¸€ï¼Œå¦‚ï¼šHomePCï¼‰" autocomplete="off"/>
            <input type="text" id="deviceName" placeholder="è®¾å¤‡åç§°ï¼ˆå¯é€‰ï¼‰" autocomplete="off"/>
            <select id="deviceType">
                <option value="desktop">ğŸ–¥ï¸ å°å¼æœº</option>
                <option value="laptop">ğŸ’» ç¬”è®°æœ¬ç”µè„‘</option>
            </select>
            <button id="registerBtn"><i class="fas fa-paper-plane"></i> æ³¨å†Œè®¾å¤‡</button>
        </div>
        <pre class="token-output" id="tokenOutput"></pre>
    </div>

    <div class="card">
        <div class="card-header">
            <i class="fas fa-list"></i>
            <h3>è®¾å¤‡åˆ—è¡¨</h3>
        </div>
        <div id="deviceList" class="device-list">
            <div class="loading">æ­£åœ¨åŠ è½½è®¾å¤‡</div>
        </div>
    </div>
</div>

<script>
    function escapeHtml(str) {
        if (typeof str !== 'string') return '';
        return str.replace(/[&<>"']/g, tag => ({
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#39;'
        })[tag]);
    }

    const adminToken = localStorage.getItem('adminToken');
    if (!adminToken) {
        alert('è¯·å…ˆç™»å½•');
        window.location.href = 'login.html';
    }

    async function authFetch(url, options = {}) {
        const res = await fetch(url, {
            ...options,
            headers: {
                'Authorization': `Bearer ${adminToken}`,
                'Content-Type': 'application/json',
                ...(options.headers || {})
            }
        });

        if (res.status === 401) {
            localStorage.removeItem('adminToken');
            alert('ä¼šè¯å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
            window.location.href = 'login.html';
        }

        return res;
    }

    const tokenOutput = document.getElementById('tokenOutput');
    const deviceListEl = document.getElementById('deviceList');
    const registerBtn = document.getElementById('registerBtn');

    // ========== æ³¨å†Œè®¾å¤‡ ==========
    registerBtn.addEventListener('click', async () => {
        const id = document.getElementById('deviceId').value.trim();
        const name = document.getElementById('deviceName').value.trim();
        const type = document.getElementById('deviceType').value;

        if (!id) {
            alert('è¯·è¾“å…¥è®¾å¤‡IDï¼ˆå¿…é¡»å”¯ä¸€ï¼‰');
            return;
        }

        registerBtn.disabled = true;
        registerBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> æ³¨å†Œä¸­...';

        try {
            const res = await authFetch('/api/devices', {
                method: 'POST',
                body: JSON.stringify({id, name, type})
            });
            const data = await res.json();

            if (res.ok) {
                const tokenText = `âœ… è®¾å¤‡æ³¨å†ŒæˆåŠŸï¼\n\nè¯·å°†ä»¥ä¸‹ä¿¡æ¯é…ç½®åˆ°ä½ çš„è®¾å¤‡å®¢æˆ·ç«¯ä¸­ï¼š\n\nè®¾å¤‡ID: ${escapeHtml(data.id)}\nè®¾å¤‡åç§°: ${escapeHtml(data.name)}\nç±»å‹: ${data.type === 'laptop' ? 'ç¬”è®°æœ¬ç”µè„‘' : 'å°å¼æœº'}\nToken: ${escapeHtml(data.token)}`;
                tokenOutput.textContent = tokenText;
                tokenOutput.style.display = 'block';

                let copyBtn = tokenOutput.querySelector('.copy-btn');
                if (!copyBtn) {
                    copyBtn = document.createElement('button');
                    copyBtn.className = 'copy-token copy-btn';
                    copyBtn.innerText = 'ğŸ“‹ å¤åˆ¶ Token';
                    copyBtn.onclick = () => {
                        navigator.clipboard.writeText(data.token).then(() => {
                            copyBtn.innerText = 'âœ… å·²å¤åˆ¶';
                            setTimeout(() => copyBtn.innerText = 'ğŸ“‹ å¤åˆ¶ Token', 2000);
                        }).catch(() => alert('å¤åˆ¶å¤±è´¥'));
                    };
                    const container = document.createElement('div');
                    container.className = 'copy-btn-container';
                    container.appendChild(copyBtn);
                    tokenOutput.appendChild(container);
                }

                setTimeout(() => tokenOutput.style.display = 'none', 8000);

                document.getElementById('deviceId').value = '';
                document.getElementById('deviceName').value = '';
                loadDevices();
            } else {
                const err = await res.json().catch(() => ({}));
                alert('âŒ ' + (err.error || 'æ³¨å†Œå¤±è´¥'));
            }
        } catch (err) {
            alert('ç½‘ç»œé”™è¯¯: ' + err.message);
        } finally {
            registerBtn.disabled = false;
            registerBtn.innerHTML = '<i class="fas fa-paper-plane"></i> æ³¨å†Œè®¾å¤‡';
        }
    });

    // ========== æ‰§è¡Œæ“ä½œ ==========
    async function performAction(action, deviceId, taskId = null, payload = null, buttonElement = null) {
        if (buttonElement) {
            buttonElement.classList.add('processing');
            buttonElement.disabled = true;
            const originalHTML = buttonElement.innerHTML;
            buttonElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i> å¤„ç†ä¸­...';
        }

        let url, method, body;

        try {
            if (action.startsWith('shutdown-')) {
                const subAction = action.replace('shutdown-', '');
                switch (subAction) {
                    case 'add':
                        url = `/api/devices/${deviceId}/shutdown-tasks`;
                        method = 'POST';
                        body = JSON.stringify(payload);
                        break;
                    case 'pause':
                        url = `/api/devices/${deviceId}/shutdown-tasks/${taskId}/pause`;
                        method = 'POST';
                        break;
                    case 'resume':
                        url = `/api/devices/${deviceId}/shutdown-tasks/${taskId}/resume`;
                        method = 'POST';
                        break;
                    case 'delete':
                        url = `/api/devices/${deviceId}/shutdown-tasks/${taskId}`;
                        method = 'DELETE';
                        break;
                    default:
                        throw new Error('æœªçŸ¥å…³æœºæ“ä½œ');
                }
            } else if (action.startsWith('wakeup-')) {
                const subAction = action.replace('wakeup-', '');
                switch (subAction) {
                    case 'add':
                        url = `/api/devices/${deviceId}/wakeup-tasks`;
                        method = 'POST';
                        body = JSON.stringify(payload);
                        break;
                    case 'pause':
                        url = `/api/devices/${deviceId}/wakeup-tasks/${taskId}/pause`;
                        method = 'POST';
                        break;
                    case 'resume':
                        url = `/api/devices/${deviceId}/wakeup-tasks/${taskId}/resume`;
                        method = 'POST';
                        break;
                    case 'delete':
                        url = `/api/devices/${deviceId}/wakeup-tasks/${taskId}`;
                        method = 'DELETE';
                        break;
                    default:
                        throw new Error('æœªçŸ¥å¼€æœºæ“ä½œ');
                }
            } else if (action === 'shutdown') {
                url = `/api/devices/${deviceId}/shutdown`;
                method = 'POST';
            } else if (action === 'wakeup') {
                url = `/api/devices/${deviceId}/wakeup`;
                method = 'POST';
            } else {
                throw new Error('æœªçŸ¥æ“ä½œ: ' + action);
            }

            const res = await authFetch(url, {method, body});
            if (!res.ok) {
                const err = await res.json().catch(() => ({}));
                if (err.pending) {
                    alert('â„¹ï¸ æŒ‡ä»¤å·²å‘é€ï¼Œè®¾å¤‡å°†åœ¨ä¸‹æ¬¡å¿ƒè·³æ—¶æ‰§è¡Œ');
                } else {
                    throw new Error(err.error || 'æ“ä½œå¤±è´¥');
                }
            }
            loadDevices();
            return true;
        } catch (err) {
            alert('âŒ ' + err.message);
            return false;
        } finally {
            if (buttonElement) {
                setTimeout(() => {
                    buttonElement.classList.remove('processing');
                    buttonElement.disabled = false;
                    // ä¸æ¢å¤ innerHTMLï¼Œå› ä¸º loadDevices() ä¼šåˆ·æ–°æ•´ä¸ªåŒºåŸŸ
                }, 500);
            }
        }
    }

    // ========== æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨ ==========
    function renderTaskList(tasks, deviceId, taskType) {
        if (!Array.isArray(tasks) || tasks.length === 0) {
            return `<div class="schedule-info none"><i class="fas fa-ban"></i> æš‚æ— ${taskType === 'shutdown' ? 'å…³æœº' : 'å¼€æœº'}ä»»åŠ¡</div>`;
        }
        return tasks.map(task => {
            const isActive = task.active;
            const isRunning = task.running;
            const statusText = isActive ? (isRunning ? 'è¿è¡Œä¸­' : 'å¯ç”¨ä½†æœªè°ƒåº¦') : 'å·²æš‚åœ';
            const statusClass = isActive && isRunning ? 'running' : (isActive ? '' : 'paused');
            const timeStr = `${String(task.hour).padStart(2, '0')}:${String(task.minute).padStart(2, '0')}`;
            const actionPrefix = taskType === 'shutdown' ? 'shutdown' : 'wakeup';

            return `
                <div class="schedule-info ${statusClass}">
                    <div class="task-time">${timeStr}</div>
                    <small>çŠ¶æ€: ${statusText}</small>
                    <div style="margin-top:6px; display:flex; gap:6px; flex-wrap:wrap;">
                        ${isActive ?
                `<button class="warning" data-action="${actionPrefix}-pause" data-device-id="${deviceId}" data-task-id="${task.id}">
                    <i class="fas fa-pause"></i> æš‚åœ
                </button>` :
                `<button class="secondary" data-action="${actionPrefix}-resume" data-device-id="${deviceId}" data-task-id="${task.id}">
                    <i class="fas fa-play"></i> æ¢å¤
                </button>`
            }
                        <button data-action="${actionPrefix}-delete" data-device-id="${deviceId}" data-task-id="${task.id}">
                            <i class="fas fa-trash"></i> åˆ é™¤
                        </button>
                    </div>
                </div>
            `;
        }).join('');
    }

    // ========== äº‹ä»¶å§”æ‰˜ ==========
    deviceListEl.addEventListener('click', async (e) => {
        const btn = e.target.closest('button[data-action]');
        if (!btn || btn.classList.contains('processing')) return;

        const action = btn.dataset.action;
        const deviceId = btn.dataset.deviceId;
        const taskId = btn.dataset.taskId;

        if (action === 'shutdown') {
            if (!confirm(`ç¡®å®šè¦è¿œç¨‹å…³é—­è®¾å¤‡ "${deviceId}" å—ï¼Ÿ`)) return;
            await performAction('shutdown', deviceId, null, null, btn);
        } else if (action === 'wakeup') {
            if (!confirm(`ç¡®å®šè¦è¿œç¨‹å”¤é†’è®¾å¤‡ "${deviceId}" å—ï¼Ÿ`)) return;
            await performAction('wakeup', deviceId, null, null, btn);
        } else if (action === 'add-shutdown-schedule') {
            const hour = prompt('å…³æœºå°æ—¶ï¼ˆ0-23ï¼‰', '22');
            const minute = prompt('å…³æœºåˆ†é’Ÿï¼ˆ0-59ï¼‰', '00');
            if (hour === null || minute === null) return;
            const h = parseInt(hour), m = parseInt(minute);
            if (isNaN(h) || isNaN(m) || h < 0 || h > 23 || m < 0 || m > 59) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆæ—¶é—´');
                return;
            }
            await performAction('shutdown-add', deviceId, null, {hour: h, minute: m}, btn);
        } else if (action === 'add-wakeup-schedule') {
            const hour = prompt('å¼€æœºå°æ—¶ï¼ˆ0-23ï¼‰', '08');
            const minute = prompt('å¼€æœºåˆ†é’Ÿï¼ˆ0-59ï¼‰', '00');
            if (hour === null || minute === null) return;
            const h = parseInt(hour), m = parseInt(minute);
            if (isNaN(h) || isNaN(m) || h < 0 || h > 23 || m < 0 || m > 59) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆæ—¶é—´');
                return;
            }
            await performAction('wakeup-add', deviceId, null, {hour: h, minute: m}, btn);
        } else if (action.endsWith('-pause') || action.endsWith('-resume') || action.endsWith('-delete')) {
            const isDelete = action.includes('delete');
            const msg = isDelete ? 'ç¡®å®šåˆ é™¤æ­¤ä»»åŠ¡ï¼Ÿæ­¤æ“ä½œä¸å¯é€†ã€‚' : 'ç¡®å®šæ‰§è¡Œæ­¤æ“ä½œï¼Ÿ';
            if (!confirm(msg)) return;
            await performAction(action, deviceId, taskId, null, btn);
        }
    });

    // ========== æ¸²æŸ“è®¾å¤‡ ==========
    function renderDevices(devices) {
        if (devices.length === 0) {
            deviceListEl.innerHTML = '<div class="empty">æš‚æ— è®¾å¤‡ï¼Œè¯·å…ˆæ·»åŠ </div>';
            return;
        }

        let html = '';
        devices.forEach(d => {
            const isOnline = d.online;
            const statusClass = isOnline ? '' : 'offline';
            const deviceIcon = d.type === 'laptop' ? 'fa-laptop' : 'fa-desktop';

            const displayName = escapeHtml(d.name || d.id);
            const displayId = escapeHtml(d.id);
            const deviceTypeText = d.type === 'laptop' ? 'ç¬”è®°æœ¬' : 'å°å¼æœº';
            const lastSeen = escapeHtml(d.lastSeen || 'ä»æœª');

            const shutdownTasksHtml = renderTaskList(d.shutdownTasks, d.id, 'shutdown');
            const wakeupTasksHtml = d.type === 'desktop'
                ? renderTaskList(d.wakeupTasks, d.id, 'wakeup')
                : `<div class="schedule-info none"><i class="fas fa-laptop"></i> ç¬”è®°æœ¬ä¸æ”¯æŒå®šæ—¶å¼€æœº</div>`;

            html += `
                <div class="device-item ${statusClass}">
                    <div class="device-meta">
                        <div class="device-name">
                            <i class="fas ${deviceIcon}"></i> ${displayName}
                        </div>
                        <div class="device-id-type">
                            ID: ${displayId} Â· ç±»å‹: ${deviceTypeText}
                        </div>
                        <div class="last-seen">
                            <span class="status-indicator ${isOnline ? 'status-online' : 'status-offline'}"></span>
                            ${isOnline ? 'åœ¨çº¿' : 'ç¦»çº¿'} Â· æœ€ååœ¨çº¿: ${lastSeen}
                        </div>
                        <div class="device-actions">
                            ${isOnline ?
                `<button class="danger" data-action="shutdown" data-device-id="${d.id}">
                    <i class="fas fa-power-off"></i> ç«‹å³å…³æœº
                </button>` :
                (d.type === 'desktop' ?
                        `<button class="warning" data-action="wakeup" data-device-id="${d.id}">
                        <i class="fas fa-plug"></i> è¿œç¨‹å¼€æœº
                    </button>` :
                        `<button disabled><i class="fas fa-ban"></i> å·²ç¦»çº¿</button>`
                )
            }
                            <button data-action="add-shutdown-schedule" data-device-id="${d.id}">
                                <i class="fas fa-plus"></i> æ–°å»ºå…³æœºä»»åŠ¡
                            </button>
                            ${d.type === 'desktop' ? `
                            <button data-action="add-wakeup-schedule" data-device-id="${d.id}">
                                <i class="fas fa-clock"></i> å®šæ—¶å¼€æœºä»»åŠ¡
                            </button>
                            ` : ''}
                        </div>
                    </div>
                    <div style="display:flex; flex-direction:column; gap:24px;">
                        <div class="schedule-section">
                            <div class="schedule-header"><i class="fas fa-clock"></i> å®šæ—¶å…³æœº (${d.shutdownTasks?.length || 0})</div>
                            ${shutdownTasksHtml}
                        </div>
                        ${d.type === 'desktop' ? `
                        <div class="schedule-section">
                            <div class="schedule-header"><i class="fas fa-sun"></i> å®šæ—¶å¼€æœº (${d.wakeupTasks?.length || 0})</div>
                            ${wakeupTasksHtml}
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;
        });

        deviceListEl.innerHTML = html;
    }

    // ========== åŠ è½½è®¾å¤‡ ==========
    let loading = false;
    let cachedDevices = null;
    let isFirstLoad = true;

    async function loadDevices() {
        if (loading) return;
        loading = true;

        if (isFirstLoad) {
            deviceListEl.innerHTML = '<div class="loading">æ­£åœ¨åŠ è½½è®¾å¤‡</div>';
        }

        try {
            const res = await authFetch('/api/devices');
            const devices = await res.json();

            const devicesStr = JSON.stringify(devices);
            const cachedStr = JSON.stringify(cachedDevices);

            if (devicesStr !== cachedStr) {
                cachedDevices = devices;
                renderDevices(devices);
            }

            isFirstLoad = false;
        } catch (err) {
            cachedDevices = null;
            deviceListEl.innerHTML = `<div class="empty">åŠ è½½å¤±è´¥: ${escapeHtml(err.message)}</div>`;
            isFirstLoad = false;
        } finally {
            loading = false;
        }
    }

    setInterval(loadDevices, 5000);
    loadDevices();
</script>
</body>
</html>