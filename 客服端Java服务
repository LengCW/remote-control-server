import java.io.*;
import java.net.*;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;

public class RemoteClient {
    // ========== ðŸ”‘ è¯·ä¿®æ”¹è¿™ä¸‰è¡Œï¼ ==========
    private static final String DEVICE_ID = "xxx";//æœåŠ¡ç«¯å¡«å†™çš„è®¾å¤‡ID
    private static final String TOKEN = "xxxxx"; //æœåŠ¡ç«¯æ·»åŠ è®¾å¤‡èŽ·å–token
    private static final String SERVER_URL = "http://xxxx";//æœåŠ¡å™¨åœ°å€
    // ======================================

    private static final int HEARTBEAT_INTERVAL = 30; // ç§’
    private static final String LOG_FILE = "remote_client.log";

    public static void main(String[] args) {
        log("âœ… è¿œç¨‹å…³æœºå®¢æˆ·ç«¯å¯åŠ¨ï¼ˆä½¿ç”¨ heartbeat æŽ¥å£ï¼‰");
        log("ðŸ†” è®¾å¤‡ID: " + DEVICE_ID);

        while (true) {
            try {
                URL url = new URL(SERVER_URL + "/api/devices/" + DEVICE_ID + "/heartbeat");
                HttpURLConnection conn = (HttpURLConnection) url.openConnection();
                conn.setRequestMethod("POST");
                conn.setRequestProperty("X-Device-Token", TOKEN); // âš ï¸ æ³¨æ„ header å
                conn.setConnectTimeout(10_000);
                conn.setReadTimeout(10_000);
                conn.setDoOutput(true); // å¿…é¡»è®¾ç½®ï¼Œå› ä¸ºæ˜¯ POST

                // å‘é€ç©º bodyï¼ˆæœåŠ¡ç«¯ä¸è¦æ±‚ bodyï¼‰
                try (OutputStream os = conn.getOutputStream()) {
                    os.write("{}".getBytes("UTF-8")); // æˆ–è€…ç•™ç©ºä¹Ÿè¡Œï¼Œä½†æœ‰äº›æœåŠ¡å™¨è¦æ±‚æœ‰ body
                }

                int responseCode = conn.getResponseCode();
                String response = readResponse(conn);

                if (responseCode == 200) {
                    if (response.contains("\"shutdown\":true")) {
                        log("ðŸ”´ æ”¶åˆ°è¿œç¨‹å…³æœºæŒ‡ä»¤ï¼");
                        Runtime.getRuntime().exec("shutdown /s /t 10 /c \"ç³»ç»Ÿå°†åœ¨10ç§’åŽå…³é—­ï¼ˆè¿œç¨‹æŒ‡ä»¤ï¼‰\"");
                        log("âœ… å…³æœºå‘½ä»¤å·²æ‰§è¡Œï¼Œå®¢æˆ·ç«¯é€€å‡ºã€‚");
                        break;
                    } else {
                        log("ðŸ’“ å¿ƒè·³æ­£å¸¸ï¼Œæ— å…³æœºæŒ‡ä»¤");
                    }
                } else {
                    log("âŒ API é”™è¯¯ (" + responseCode + "): " + response);
                }

                conn.disconnect();
            } catch (Exception e) {
                log("âš ï¸ å¼‚å¸¸: " + e.getMessage());
            }

            try {
                Thread.sleep(HEARTBEAT_INTERVAL * 1000L);
            } catch (InterruptedException e) {
                log("ðŸ‘‹ ç¨‹åºè¢«ä¸­æ–­");
                break;
            }
        }
    }

    private static String readResponse(HttpURLConnection connection) throws IOException {
        InputStream is = connection.getResponseCode() >= 400
                ? connection.getErrorStream()
                : connection.getInputStream();
        if (is == null) return "";
        try (BufferedReader reader = new BufferedReader(new InputStreamReader(is))) {
            return reader.lines().reduce("", (a, b) -> a + b);
        }
    }

    private static void log(String message) {
        String timestamp = LocalDateTime.now().format(DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss"));
        String line = timestamp + " | " + message;
        System.out.println(line);
        try (FileWriter fw = new FileWriter(LOG_FILE, true)) {
            fw.write(line + System.lineSeparator());
        } catch (IOException ignored) {}
    }
}
